{"version":3,"sources":["../../../../src/google-cloud/oauth/android/login.process.ts"],"names":["_"],"mappings":"AACA,OAAiC,cAAe,QAAW,WAC3D,OAAa,eAAkB,YAE/B,SAAS,KAAK,EAAO,CACpB,QAAQ,MAAM,CAAC,EAEf,QAAQ,KAAK,EAAE,CAChB,CAEA,QAAQ,GAAG,oBAAqB,IAAI,EACpC,QAAQ,GAAG,qBAAsB,IAAI,EAErC,IAAI,QAEJ,SAAS,cAAc,QAAiB,CACvC,OAAO,IAAI,QAAgB,CAAC,QAAS,IAAM,CAC1C,IAAI,QAAU,CAACA,GAAU,SAAmB,CACxC,OAAO,QAAU,uBAAyB,OAAO,MAAQ,gBAE5D,QAAQ,QAAQ,IAAI,UAAW,OAAO,EAEtC,QAAQ,OAAO,KAAK,EACrB,EAEA,QAAQ,QAAQ,GAAG,UAAW,OAAO,CACtC,CAAC,CACF,CAEA,eAAe,MAAM,CACpB,IAAI,IAAM,IAAI,cAAc,CAAE,MAAO,IAAK,OAAQ,GAAI,CAAC,EACnD,QAAU,IAAI,YAAY,QAE1B,KAED,SAAS,WACX,IAAI,YAAY,aAAa,QAAQ,SAAS,EAC/C,GAAG,CACF,IAAI,IAAM,IAAI,WAAW,uDAAuD,EAEhF,IAAI,UAAU,SAAS,IAAI,EAC3B,IAAI,QAAQ,IAAI,EAEhB,MAAM,IAAI,QAAQ,IAAI,IAAI,EAE1B,KAAO,MAAM,cAAc,OAAO,EAE/B,QAAQ,KACV,QAAQ,KAAK,CACZ,OAAQ,IACT,CAAC,EAED,QAAQ,IAAI,IAAI,CAElB,OAAO,EAAE,CACR,QAAQ,MAAM,CAAC,CAChB,CAEA,QAAQ,iBAAiB,EACzB,IAAI,MAAM,CACX,CAEA,IAAI,GAAG,oBAAqB,IAAM,CACjC,IAAI,KAAK,CACV,CAAC,EAEE,QAAQ,MACV,QAAQ,KAAK,CACZ,MAAO,EACR,CAAC,EAED,QAAQ,GAAG,UAAY,MAAc,CACpC,IAAI,QAAU,KAEX,QAAQ,OACV,IAAI,UAAU,EAAE,KAAK,IAAI,EACvB,QAAQ,UACV,QAAU,QAAQ,QACpB,CAAC,GAED,IAAI,UAAU,EAAE,KAAK,IAAI","sourcesContent":["import { OAuthElectronIPCMessage } from 'mosaic';\nimport { Session, Event, Cookie, BrowserWindow, app } from 'electron';\nimport { KV, URLBuilder } from 'js-common';\n\nfunction exit(e: any){\n\tconsole.error(e);\n\n\tprocess.exit(-1);\n}\n\nprocess.on('uncaughtException', exit);\nprocess.on('unhandledRejection', exit);\n\nlet options: KV<any> | undefined;\n\nfunction loginComplete(session: Session){\n\treturn new Promise<string>((resolve, _) => {\n\t\tlet changed = (_: Event, cookie: Cookie) => {\n\t\t\tif(cookie.domain != 'accounts.google.com' || cookie.name != 'oauth_token')\n\t\t\t\treturn;\n\t\t\tsession.cookies.off('changed', changed);\n\n\t\t\tresolve(cookie.value);\n\t\t};\n\n\t\tsession.cookies.on('changed', changed);\n\t});\n}\n\nasync function auth(){\n\tlet win = new BrowserWindow({ width: 450, height: 580 });\n\tlet session = win.webContents.session;\n\n\tlet code;\n\n\tif(options?.userAgent)\n\t\twin.webContents.setUserAgent(options.userAgent);\n\ttry{\n\t\tlet url = new URLBuilder('https://accounts.google.com/embedded/setup/v2/android');\n\n\t\turl.setParams(options?.form);\n\t\twin.setMenu(null);\n\n\t\tawait win.loadURL(url.href);\n\n\t\tcode = await loginComplete(session);\n\n\t\tif(process.send){\n\t\t\tprocess.send({\n\t\t\t\toutput: code\n\t\t\t});\n\t\t}else{\n\t\t\tconsole.log(code);\n\t\t}\n\t}catch(e){\n\t\tconsole.error(e);\n\t}\n\n\tsession.clearStorageData();\n\twin.close();\n}\n\napp.on('window-all-closed', () => {\n\tapp.quit();\n});\n\nif(process.send){\n\tprocess.send({\n\t\tready: true\n\t});\n\n\tprocess.on('message', (data: any) => {\n\t\tlet message = data as OAuthElectronIPCMessage;\n\n\t\tif(message.start)\n\t\t\tapp.whenReady().then(auth);\n\t\tif(message.options)\n\t\t\toptions = message.options;\n\t});\n}else{\n\tapp.whenReady().then(auth);\n}"]}